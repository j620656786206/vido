# Vido E2E Test Pipeline
# Generated by TEA (Test Architect) - BMAD Framework
# Date: 2026-01-25
#
# Pipeline stages:
# 1. lint: Code quality checks (ESLint + Prettier)
# 2. test-changed-specs: Burn-in on changed test files (PR only)
# 3. test-e2e-sharded: Parallel E2E tests (4 shards)
# 4. merge-test-results: Aggregate HTML reports

name: E2E Tests

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      burn_in_iterations:
        description: 'Number of burn-in iterations'
        required: false
        default: '10'
      run_full_suite:
        description: 'Run full test suite (skip selective testing)'
        required: false
        type: boolean
        default: false

env:
  CI: true

jobs:
  # =============================================================================
  # Stage 1: Lint (Code Quality)
  # =============================================================================
  lint:
    name: Lint & Format Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint

      - name: Check formatting
        run: npm run format:check

  # =============================================================================
  # Stage 2: Burn-In on Changed Specs (Flaky Test Detection) - PR Only
  # =============================================================================
  test-changed-specs:
    name: Burn-In Changed Specs
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Detect changed test files
        id: changed-tests
        run: |
          CHANGED_SPECS=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '\.(spec|test)\.(ts|js)$' || echo "")
          echo "changed_specs<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_SPECS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          if [ -n "$CHANGED_SPECS" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changed specs:"
            echo "$CHANGED_SPECS"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No test files changed"
          fi

      - name: Run burn-in on changed specs
        if: steps.changed-tests.outputs.has_changes == 'true'
        run: |
          ITERATIONS=${{ github.event.inputs.burn_in_iterations || '10' }}
          SPECS="${{ steps.changed-tests.outputs.changed_specs }}"
          echo "Running burn-in: $ITERATIONS iterations on changed specs"
          for i in $(seq 1 $ITERATIONS); do
            echo "üî• Burn-in iteration $i/$ITERATIONS"
            npx playwright test $SPECS --project=chromium || {
              echo "‚ùå Burn-in failed on iteration $i"
              exit 1
            }
          done
          echo "‚úÖ Burn-in passed - $ITERATIONS/$ITERATIONS successful runs"

      - name: Upload burn-in artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: burn-in-failure-artifacts
          path: |
            test-results/
            playwright-report/
          retention-days: 7

  # =============================================================================
  # Stage 3: E2E Tests (Parallel Shards)
  # =============================================================================
  test-e2e-sharded:
    name: E2E Tests (Shard ${{ matrix.shard }}/4)
    needs: lint
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        shard: [1, 2, 3, 4]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run E2E tests (shard ${{ matrix.shard }}/4)
        run: npx playwright test --shard=${{ matrix.shard }}/4 --project=chromium
        env:
          TEST_ENV: ci
          BASE_URL: http://localhost:4200
          API_URL: http://localhost:8080/api/v1

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-shard-${{ matrix.shard }}
          path: |
            test-results/
            playwright-report/
          retention-days: 30

  # =============================================================================
  # Stage 4: Merge Test Results & Generate Report
  # =============================================================================
  merge-test-results:
    name: Merge Test Results
    needs: test-e2e-sharded
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download all shard results
        uses: actions/download-artifact@v4
        with:
          pattern: test-results-shard-*
          path: all-results/
          merge-multiple: true

      - name: Merge HTML reports
        run: npx playwright merge-reports --reporter=html ./all-results/
        continue-on-error: true

      - name: Upload merged report
        uses: actions/upload-artifact@v4
        with:
          name: merged-playwright-report
          path: playwright-report/
          retention-days: 30
          if-no-files-found: ignore

  # =============================================================================
  # Weekly Burn-In (Full Suite Stability Check)
  # =============================================================================
  weekly-burn-in:
    name: Weekly Burn-In (Full Suite)
    if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && github.event.inputs.run_full_suite == 'true')
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run burn-in loop (10 iterations)
        run: |
          for i in {1..10}; do
            echo "üî• Burn-in iteration $i/10"
            npx playwright test --project=chromium || {
              echo "‚ùå Burn-in failed on iteration $i"
              exit 1
            }
          done
          echo "‚úÖ Full suite burn-in passed - 10/10 successful runs"

      - name: Upload failure artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: weekly-burn-in-failures
          path: |
            test-results/
            playwright-report/
          retention-days: 30
